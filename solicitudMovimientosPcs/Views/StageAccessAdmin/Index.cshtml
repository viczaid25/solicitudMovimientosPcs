@using solicitudMovimientosPcs.Models.Security
@model IEnumerable<StageAccess>
@{
    ViewData["Title"] = "Permisos por etapa";
    string searchUrl = Url.Action("SearchUsers", "StageAccessAdmin"); // /Admin/StageAccess/SearchUsers
    string[] etapas = new[] { "MNG", "JPN", "MC", "PL", "PCMNG", "PCJPN", "FINMNG", "FINJPN" };
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><i class="fas fa-user-shield me-2"></i>Permisos por etapa</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mdlNew">
        <i class="fas fa-plus me-1"></i> Nuevo permiso
    </button>
</div>

@if (TempData["Ok"] != null) { <div class="alert alert-success">@TempData["Ok"]</div> }
@if (TempData["Err"] != null) { <div class="alert alert-danger">@TempData["Err"]</div> }
@if (TempData["Msg"] != null) { <div class="alert alert-info">@TempData["Msg"]</div> }

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="min-width:110px">Etapa</th>
                        <th style="min-width:220px">Usuario (USERNAME)</th>
                        <th style="min-width:260px">Email (override)</th>
                        <th style="min-width:120px" class="text-center">Puede ver</th>
                        <th style="min-width:120px" class="text-center">Puede aprobar</th>
                        <th style="min-width:140px" class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var x in Model ?? Enumerable.Empty<StageAccess>())
                    {
                        <tr>
                            <td>@x.Stage</td>
                            <td>@x.UserName</td>
                            <td>@(string.IsNullOrWhiteSpace(x.EmailOverride) ? "-" : x.EmailOverride)</td>
                            <td class="text-center">
                                <span class="badge @(x.CanView ? "bg-success" : "bg-secondary")">
                                    @(x.CanView ? "Sí" : "No")
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge @(x.CanApprove ? "bg-success" : "bg-secondary")">
                                    @(x.CanApprove ? "Sí" : "No")
                                </span>
                            </td>
                            <td class="text-end">
                                <form class="d-inline" method="post"
                                      asp-controller="StageAccessAdmin" asp-action="Revoke"
                                      asp-route-id="@x.Id"
                                      onsubmit="return confirm('¿Quitar permiso de @x.UserName en @x.Stage?');">
                                    @Html.AntiForgeryToken()
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                    @if (!(Model?.Any() ?? false))
                    {
                        <tr><td colspan="6" class="text-center text-muted py-4">Sin permisos registrados.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Nuevo (usa POST /Admin/StageAccess/Grant) -->
<div class="modal fade" id="mdlNew" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-controller="StageAccessAdmin" asp-action="Grant">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo permiso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body vstack gap-3">
                    <div>
                        <label class="form-label req">Etapa</label>
                        <select name="stage" class="form-select" required>
                            <option value="">-- Selecciona --</option>
                            @foreach (var e in etapas) { <option value="@e">@e</option> }
                        </select>
                    </div>

                    <div>
                        <label class="form-label req">Usuario (USERNAME o PC_LOGIN_ID)</label>
                        <input name="displayName" id="userNameNew" class="form-control"
                               placeholder="Escribe al menos 2 letras..." list="user-suggest-new"
                               autocomplete="off" required />
                        <datalist id="user-suggest-new"></datalist>
                        <div class="form-text">
                            Busca en <code>dbo.users_ad</code> por USERNAME / EMAIL / PC_LOGIN_ID.
                        </div>
                    </div>

                    <!-- Si más adelante amplías Grant(...) para aceptar estos campos,
                         puedes descomentar y usar los mismos names -->
                    @*<div>
                        <label class="form-label">Email (override, opcional)</label>
                        <input name="emailOverride" class="form-control" placeholder="usuario@dominio.com" />
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="canView" id="nv">
                                <label class="form-check-label" for="nv">Puede ver</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="canApprove" id="na">
                                <label class="form-check-label" for="na">Puede aprobar</label>
                            </div>
                        </div>
                    </div>*@
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary"><i class="fas fa-save me-1"></i> Guardar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .req::after { content:" *"; color:#dc3545; font-weight:700; }
    </style>
}

@section Scripts {
<script>
(function () {
  const SEARCH_URL = '@searchUrl';
  const dlNew = document.getElementById('user-suggest-new');
  const inpNew = document.getElementById('userNameNew');

  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  async function fetchUsers(term){
    if (!term || term.trim().length < 2) return [];
    const res = await fetch(SEARCH_URL + '?term=' + encodeURIComponent(term.trim()), { headers:{'Accept':'application/json'} });
    if (!res.ok) return [];
    return await res.json(); // [{username,email,login}]
  }

  const pumpNew = debounce(async ()=>{
    const data = await fetchUsers(inpNew.value || '');
    dlNew.innerHTML = data.map(u => {
      const label = (u.username || u.login) + (u.email ? (' — ' + u.email) : '');
      const value = u.username || u.login; // lo que enviamos en el form
      return `<option value="${value}" label="${label}"></option>`;
    }).join('');
  }, 250);

  inpNew.addEventListener('input', pumpNew);
})();
</script>
}
