@model solicitudMovimientosPcs.Models.PcMovimientosRequest
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = (Model?.Id > 0 ? "Editar Solicitud" : "Nueva Solicitud");

    var clases = ViewBag.Clases as IEnumerable<SelectListItem>;
    var ubicaciones = ViewBag.Ubicaciones as IEnumerable<SelectListItem>;
    var codMovs = ViewBag.CodMovs as IEnumerable<SelectListItem>;
    var estatus = ViewBag.Estatus as IEnumerable<SelectListItem>;
    var monedas = ViewBag.Monedas as IEnumerable<SelectListItem>;
    var lineas = ViewBag.Lineas as IEnumerable<SelectListItem>;

    var solicitanteActual = !string.IsNullOrWhiteSpace(Model?.Solicitante)
        ? Model.Solicitante
        : (User.FindFirst("DisplayName")?.Value ?? User.Identity?.Name ?? "");

    bool isEdit = Model?.Id > 0;
    string titleIcon = isEdit ? "fa-pen-to-square" : "fa-plus-circle";
}

<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="fas @titleIcon me-2"></i>@(isEdit ? "Editar Solicitud" : "Nueva Solicitud")</h4>
    </div>
    <div class="card-body">

        <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

        <form asp-action="@(isEdit ? "Edit" : "Create")"
              asp-route-id="@(Model?.Id)"
              method="post" id="frmCreate" autocomplete="off"
              enctype="multipart/form-data">
            @Html.AntiForgeryToken()

            <div class="row g-3">
                <!-- FECHA -->
                <div class="col-md-3">
                    <label class="form-label req">Fecha</label>
                    <input class="form-control" value="@Model.Fecha.ToString("yyyy-MM-dd HH:mm")" readonly />
                </div>

                <!-- SOLICITANTE -->
                <div class="col-md-3">
                    <label class="form-label req">Solicitante</label>
                    <input class="form-control" value="@solicitanteActual" readonly />
                    <input type="hidden" name="Solicitante" value="@solicitanteActual" />
                </div>

                <!-- DEPARTAMENTO -->
                <div class="col-md-3">
                    <label class="form-label req">Departamento</label>
                    <select asp-for="Departamento" class="form-select" required>
                        <option value="">-- Selecciona --</option>
                        @foreach (var d in new[] { "MELX", "SAL", "IT", "PD", "LGL", "PRC", "TOP", "HR", "FIN", "QC", "PC", "FC" })
                        {
                            <option value="@d">@d</option>
                        }
                    </select>
                    <span asp-validation-for="Departamento" class="text-danger"></span>
                </div>

                <!-- LÍNEA -->
                <div class="col-md-3">
                    <label class="form-label req">Línea</label>
                    <select asp-for="Linea" class="form-select" asp-items="lineas" required>
                        <option value="">-- Selecciona --</option>
                    </select>
                    <span asp-validation-for="Linea" class="text-danger"></span>
                </div>

                <div class="col-12">
                    <label asp-for="Comentarios" class="form-label req">Comentarios</label>
                    <textarea asp-for="Comentarios" class="form-control" rows="2" required></textarea>
                    <span asp-validation-for="Comentarios" class="text-danger"></span>
                </div>

                <!-- URGENCIA -->
                <div class="col-md-3">
                    <label class="form-label req">Urgencia</label>
                    <select asp-for="Urgencia" class="form-select" asp-items="Html.GetEnumSelectList<Urgencia>()" required></select>
                    <span asp-validation-for="Urgencia" class="text-danger"></span>
                </div>
            </div>

            <hr class="my-3" />
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label fw-semibold">Tipo de Movimiento (selecciona los que apliquen)</label>
                    <div class="d-flex flex-wrap gap-3">
                        @{
                            var tiposCsv = Model?.PcTiposMovimiento ?? "";
                            bool chk(string v) => tiposCsv.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                            .Any(x => string.Equals(x, v, StringComparison.OrdinalIgnoreCase));
                        }
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="tmFDO" name="TiposMovimiento" value="FDO" @(chk("FDO") ? "checked" : "") />
                            <label class="form-check-label" for="tmFDO">FDO</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="tmPDO" name="TiposMovimiento" value="PDO" @(chk("PDO") ? "checked" : "") />
                            <label class="form-check-label" for="tmPDO">PDO</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="tmWDO" name="TiposMovimiento" value="WDO" @(chk("WDO") ? "checked" : "") />
                            <label class="form-check-label" for="tmWDO">WDO</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="tmMLO" name="TiposMovimiento" value="MLO" @(chk("MLO") ? "checked" : "") />
                            <label class="form-check-label" for="tmMLO">MLO</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="tmEST" name="TiposMovimiento" value="ESTATUS" @(chk("ESTATUS") ? "checked" : "") />
                            <label class="form-check-label" for="tmEST">ESTATUS</label>
                        </div>
                    </div>
                    <div class="form-text">
                        Si seleccionas <strong>FDO</strong>, <strong>PDO</strong> o <strong>WDO</strong>, la solicitud <u>pasará</u> por aprobación de Finanzas.
                        (Ejemplo: si eliges <strong>ESTATUS</strong> y <strong>FDO</strong>, <em>sí</em> pasa por Finanzas).
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fa fa-paperclip me-2"></i> Evidencias
                    </div>
                    <div class="card-body">
                        <input type="file"
                               id="Evidencias"
                               name="Evidencias"
                               class="form-control"
                               multiple
                               accept=".pdf,.jpg,.jpeg,.png,.heic,.xlsx,.xls,.csv,.txt,.doc,.docx,.zip" />
                        <div class="form-text">
                            Hasta 10 archivos, máximo 20&nbsp;MB c/u.
                        </div>
                        <ul id="eviList" class="small mt-2 mb-0"></ul>
                    </div>
                </div>
            </div>

            <hr class="my-4" />

            <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="mb-0"><i class="fas fa-boxes-stacked me-2"></i>Items</h5>
                <div class="d-flex gap-2">
                    <button type="button" id="dupLast" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-copy me-1"></i> Duplicar última fila
                    </button>
                    <button type="button" id="addItem" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-plus me-1"></i> Agregar item
                    </button>
                </div>
            </div>

            <!-- Plantillas ocultas -->
            <select id="tpl-clases" class="d-none">
                <option value=""></option>
                @if (clases != null)
                {
                    foreach (var o in clases)
                    {
                        <option value="@o.Value">@o.Text</option>
                    }
                }
            </select>
            <select id="tpl-ubicaciones" class="d-none">
                <option value=""></option>
                @if (ubicaciones != null)
                {
                    foreach (var o in ubicaciones)
                    {
                        <option value="@o.Value">@o.Text</option>
                    }
                }
            </select>
            <select id="tpl-codmovs" class="d-none">
                <option value=""></option>
                @if (codMovs != null)
                {
                    foreach (var o in codMovs)
                    {
                        <option value="@o.Value">@o.Text</option>
                    }
                }
            </select>
            <select id="tpl-estatus" class="d-none">
                <option value=""></option>
                @if (estatus != null)
                {
                    foreach (var o in estatus)
                    {
                        <option value="@o.Value">@o.Text</option>
                    }
                }
            </select>
            <select id="tpl-monedas" class="d-none">
                <option value=""></option>
                @if (monedas != null)
                {
                    foreach (var o in monedas)
                    {
                        <option value="@o.Value">@o.Text</option>
                    }
                }
            </select>

            <!-- Tabla items -->
            <div class="table-responsive h-scroll">
                <table class="table table-sm align-middle table-nowrap table-wide" id="itemsTable">
                    <thead class="table-light">
                        <tr>
                            <th colspan="9" class="text-center">Información actual del material PCS</th>
                            <th class="sep-col"></th>
                            <th colspan="4" class="text-center thead-requested">Modificación de PCS Solicitada</th>
                            <th colspan="1" class="text-center">Diferencia</th>
                            <th colspan="3" class="text-center">Costos</th>
                            <th colspan="1" class="text-center">Acciones</th>
                        </tr>
                        <tr>
                            <!-- G1 (Actual) -->
                            <th style="min-width:70px">No.</th>
                            <th style="min-width:140px" class="req">Núm. Parte</th>
                            <th style="min-width:220px" class="req">Descripción</th>
                            <th style="min-width:170px" class="req">CodMov</th>
                            <th style="min-width:200px" class="req">Case</th>
                            <th style="min-width:170px" class="req">Ubic A (libre)</th>
                            <th style="min-width:140px" class="req">Estatus A</th>
                            <th style="min-width:140px" class="req">Clase A</th>
                            <th style="min-width:120px" class="req">Cant A</th>

                            <!-- Separador -->
                            <th class="sep-col"></th>

                            <!-- G2 (Solicitado) -->
                            <th style="min-width:140px">Estatus D</th>
                            <th style="min-width:160px">Ubic D</th>
                            <th style="min-width:140px">Clase D</th>
                            <th style="min-width:120px">Cant D</th>

                            <!-- G3 -->
                            <th style="min-width:120px">Diferencia</th>

                            <!-- G4 -->
                            <th style="min-width:120px">Moneda</th>
                            <th style="min-width:130px">Costo U</th>
                            <th style="min-width:140px">Total</th>

                            <!-- G5 -->
                            <th style="min-width:90px">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.Items.Count; i++)
                        {
                            <tr>
                                <!-- No. -> readonly -->
                                <td>
                                    <input class="form-control" asp-for="Items[@i].Numero" type="text" readonly />
                                </td>

                                <td><input class="form-control to-upper" asp-for="Items[@i].NumParte" required /></td>
                                <td><input class="form-control to-upper" asp-for="Items[@i].Descripcion" required /></td>

                                <td>
                                    <select class="form-select" asp-for="Items[@i].CodMov" asp-items="codMovs" required>
                                        <option value=""></option>
                                    </select>
                                </td>

                                <td><input class="form-control to-upper" asp-for="Items[@i].Case" required /></td>

                                <td>
                                    <input class="form-control to-upper" asp-for="Items[@i].UbicacionA" required />
                                </td>
                                <td>
                                    <select class="form-select" asp-for="Items[@i].EstatusA" asp-items="estatus" required>
                                        <option value=""></option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-select" asp-for="Items[@i].ClaseA" asp-items="clases" required>
                                        <option value=""></option>
                                    </select>
                                </td>
                                <td>
                                    <!-- CAMBIO: permite decimales -->
                                    <input class="form-control qtyA no-spinners" asp-for="Items[@i].CantidadA"
                                           type="number" step="0.01" min="0" inputmode="decimal" required />
                                </td>

                                <!-- Separador -->
                                <td class="sep-col"></td>

                                <!-- G2 -->
                                <td>
                                    <select class="form-select" asp-for="Items[@i].EstatusD" asp-items="estatus">
                                        <option value=""></option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-select" asp-for="Items[@i].UbicacionD" asp-items="ubicaciones">
                                        <option value=""></option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-select" asp-for="Items[@i].ClaseD" asp-items="clases">
                                        <option value=""></option>
                                    </select>
                                </td>
                                <td>
                                    <input class="form-control qtyD no-spinners"
                                           asp-for="Items[@i].CantidadD"
                                           type="number" step="0.01" inputmode="decimal"
                                           readonly />
                                </td>

                                <!-- G3 -->
                                <td>
                                    <input class="form-control diff"
                                           asp-for="Items[@i].Diferencia"
                                           type="number" step="0.01" />
                                </td>

                                <!-- G4 -->
                                <td>
                                    <select class="form-select" asp-for="Items[@i].Moneda" asp-items="monedas">
                                        <option value=""></option>
                                    </select>
                                </td>
                                <td><input class="form-control costU" asp-for="Items[@i].CostoU" type="number" step="0.01" /></td>
                                <td><input class="form-control total" asp-for="Items[@i].Total" type="number" step="0.01" readonly /></td>

                                <!-- G5 -->
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-danger btn-del" title="Eliminar fila">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="text-end mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Guardar
                </button>
            </div>
        </form>
    </div>
</div>

@section Styles {
    <style>
        .req::after {
            content: " *";
            color: #dc3545;
            font-weight: 700;
        }

        .table-nowrap th, .table-nowrap td {
            white-space: nowrap;
        }

        .table-wide {
            min-width: 2650px;
        }

        .sep-col {
            width: 8px;
            border-left: 3px solid #2c5fa8 !important;
            background: #f1f5ff;
        }

        .thead-requested {
            background: #f6f9ff;
        }

        .no-spinners::-webkit-outer-spin-button,
        .no-spinners::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .no-spinners {
            -moz-appearance: textfield;
        }

        .to-upper {
            text-transform: uppercase;
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
          const form = document.getElementById('frmCreate');

          // Evitar submit con Enter (excepto textarea/botón)
          form.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
              const tag = e.target.tagName.toLowerCase();
              if (tag !== 'textarea' && tag !== 'button') e.preventDefault();
            }
          });

          let idx = @Model.Items.Count;

          // Plantillas para selects (ya están en el DOM como <select id="tpl-...">)
          const tpl = {
            clases: document.getElementById('tpl-clases').innerHTML,
            ubics:  document.getElementById('tpl-ubicaciones').innerHTML,
            cods:   document.getElementById('tpl-codmovs').innerHTML,
            est:    document.getElementById('tpl-estatus').innerHTML,
            mon:    document.getElementById('tpl-monedas').innerHTML
          };

          const tableBody = document.querySelector('#itemsTable tbody');

          function toNum(v){ return parseFloat((v || '0').toString().replace(',', '.')) || 0 }

          function setInvalid(el, invalid){
            if(!el) return;
            el.classList.toggle('is-invalid', !!invalid);
          }

          // Reglas: D = A − Dif  |  Total = |Dif| × CostoU
          function recalcRow(tr){
            const qtyAEl = tr.querySelector('.qtyA');
            const diffEl = tr.querySelector('.diff');
            const qtyDEl = tr.querySelector('.qtyD');
            const costEl = tr.querySelector('.costU');
            const totEl  = tr.querySelector('.total');

            const qtyA = toNum(qtyAEl?.value);
            const diff = toNum(diffEl?.value);
            const cost = toNum(costEl?.value);

            const qtyD = qtyA - diff; // regla principal
            if (qtyDEl) qtyDEl.value = Number.isFinite(qtyD) ? qtyD.toFixed(2) : '0.00';

            const negative = qtyD < 0;
            setInvalid(qtyDEl, negative);
            setInvalid(diffEl, negative); // opcional: también marca diferencia

            const total = Math.abs(diff) * cost;
            if (totEl) totEl.value = Number.isFinite(total) ? total.toFixed(2) : '0.00';
          }

          function nextNumero(prefill){
            if (prefill && prefill.Numero){
              const n = parseInt(prefill.Numero, 10);
              return (isNaN(n) ? 0 : n) + 1;
            }
            const last = tableBody.querySelector('tr:last-child input[name$=".Numero"]');
            const ln = last ? parseInt(last.value, 10) : 0;
            return (isNaN(ln) ? 0 : ln) + 1;
          }

          function addRow(prefill) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><input class="form-control" name="Items[${idx}].Numero" type="text" value="${nextNumero(prefill)}" readonly /></td>
              <td><input class="form-control to-upper" name="Items[${idx}].NumParte" required /></td>
              <td><input class="form-control to-upper" name="Items[${idx}].Descripcion" required /></td>
              <td><select class="form-select" name="Items[${idx}].CodMov" required>${tpl.cods}</select></td>
              <td><input class="form-control to-upper" name="Items[${idx}].Case" required /></td>
              <td><input class="form-control to-upper" name="Items[${idx}].UbicacionA" required /></td>
              <td><select class="form-select" name="Items[${idx}].EstatusA" required>${tpl.est}</select></td>
              <td><select class="form-select" name="Items[${idx}].ClaseA" required>${tpl.clases}</select></td>
              <td><input class="form-control qtyA no-spinners" name="Items[${idx}].CantidadA" type="number" step="0.01" min="0" inputmode="decimal" required /></td>

              <td class="sep-col"></td>

              <td><select class="form-select" name="Items[${idx}].EstatusD">${tpl.est}</select></td>
              <td><select class="form-select" name="Items[${idx}].UbicacionD">${tpl.ubics}</select></td>
              <td><select class="form-select" name="Items[${idx}].ClaseD">${tpl.clases}</select></td>
              <td><input class="form-control qtyD no-spinners" name="Items[${idx}].CantidadD" type="number" step="0.01" inputmode="decimal" readonly /></td>

              <td><input class="form-control diff"  name="Items[${idx}].Diferencia" type="number" step="0.01" /></td>

              <td><select class="form-select" name="Items[${idx}].Moneda">${tpl.mon}</select></td>
              <td><input class="form-control costU" name="Items[${idx}].CostoU" type="number" step="0.01" /></td>
              <td><input class="form-control total" name="Items[${idx}].Total" type="number" step="0.01" readonly /></td>

              <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger btn-del" title="Eliminar fila">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            `;
            tableBody.appendChild(tr);

                  if (prefill) {
                    // helpers para prellenar SIN backticks
                    const setVal = (field, value) => {
                      const sel = '[name="Items[' + idx + '].' + field + '"]';
                      const el = tr.querySelector(sel);
                      if (el) el.value = (value ?? '');
                    };
                    const setSel = (field, value) => {
                      const sel = 'select[name="Items[' + idx + '].' + field + '"]';
                      const el = tr.querySelector(sel);
                      if (el) el.value = (value ?? '');
                    };

                    setVal('NumParte',    prefill.NumParte);
                    setVal('Descripcion', prefill.Descripcion);
                    setSel('CodMov',      prefill.CodMov);
                    setVal('Case',        prefill.Case);
                    setVal('UbicacionA',  prefill.UbicacionA);
                    setSel('EstatusA',    prefill.EstatusA);
                    setSel('ClaseA',      prefill.ClaseA);
                    setVal('CantidadA',   prefill.CantidadA);

                    setSel('EstatusD',    prefill.EstatusD);
                    setSel('UbicacionD',  prefill.UbicacionD);
                    setSel('ClaseD',      prefill.ClaseD);
                    setVal('CantidadD',   prefill.CantidadD);

                    setVal('Diferencia',  prefill.Diferencia);
                    setSel('Moneda',      prefill.Moneda);
                    setVal('CostoU',      prefill.CostoU);
                    setVal('Total',       prefill.Total);
            }

            recalcRow(tr);
            idx++;
            return tr;
          }

          function getRowData(tr) {
          const val = (n) => {
            const el = tr.querySelector('[name$="].' + n + '"]');
            return el ? el.value : '';
          };
          return {
            Numero:     val('Numero'),
            NumParte:   val('NumParte'),
            Descripcion:val('Descripcion'),
            CodMov:     val('CodMov'),
            Case:       val('Case'),
            UbicacionA: val('UbicacionA'),
            EstatusA:   val('EstatusA'),
            ClaseA:     val('ClaseA'),
            CantidadA:  val('CantidadA'),
            EstatusD:   val('EstatusD'),
            UbicacionD: val('UbicacionD'),
            ClaseD:     val('ClaseD'),
            CantidadD:  val('CantidadD'),
            Diferencia: val('Diferencia'),
            Moneda:     val('Moneda'),
            CostoU:     val('CostoU'),
            Total:      val('Total')
          };
        }

          // Recalcular ante cambios en A, Dif o Costo U
          tableBody.addEventListener('input', function(e){
            if (e.target.matches('.qtyA, .diff, .costU')) {
              const tr = e.target.closest('tr');
              recalcRow(tr);
            }
            // Uppercase visual en inputs de texto
            if (e.target.tagName === 'INPUT' && e.target.type === 'text') {
              e.target.value = (e.target.value || '').toUpperCase();
            }
          });

          // Eliminar fila
          tableBody.addEventListener('click', function(e){
            if (e.target.closest('.btn-del')) {
              const tr = e.target.closest('tr');
              if (!tr) return;
              tr.remove();
            }
          });

          // Agregar/duplicar fila
          document.getElementById('addItem')?.addEventListener('click', function () { addRow(); });
          document.getElementById('dupLast')?.addEventListener('click', function () {
            const last = tableBody.querySelector('tr:last-child');
            if (!last) { addRow(); return; }
            const data = getRowData(last);
            addRow(data);
          });

          // Inicial: recalcular y poner en mayúsculas
          document.querySelectorAll('#itemsTable tbody tr').forEach(tr => {
            recalcRow(tr);
            tr.querySelectorAll('input[type="text"]').forEach(inp => inp.value = (inp.value || '').toUpperCase());
          });

          // --- Normalización decimales para jQuery Validate (acepta 12,34) ---
          if (window.jQuery && $.validator && $.validator.methods && $.validator.methods.number) {
            const _origNumber = $.validator.methods.number;
            $.validator.methods.number = function (value, element) {
              if (typeof value === 'string') value = value.replace(',', '.');
              return _origNumber.call(this, value, element);
            };
          }

          // Antes de enviar: recalc total y D en todas las filas, bloquear si D<0, normalizar coma->punto
          form.addEventListener('submit', function (e) {
            let invalid = false;
            document.querySelectorAll('#itemsTable tbody tr').forEach(function(tr){
              recalcRow(tr);
              const qd = toNum(tr.querySelector('.qtyD')?.value);
              if (qd < 0) invalid = true;
            });
            if (invalid) {
              e.preventDefault();
              alert('Hay filas con Cant D negativa. Ajusta la Diferencia para que D = A − Dif no sea negativa.');
              return;
            }
            document.querySelectorAll('.qtyA, .qtyD, .diff, .costU, .total').forEach(function (el) {
              if (typeof el.value === 'string') el.value = el.value.replace(',', '.');
            });
          });
        })();
    </script>
    <script>
        (function(){
          const input = document.getElementById('Evidencias');
          const list  = document.getElementById('eviList');
          const MAX_COUNT = 10;
          const MAX_SIZE  = 20 * 1024 * 1024; // 20MB
          const ALLOWED   = ['pdf','jpg','jpeg','png','heic','xlsx','xls','csv','txt','doc','docx','zip'];

          function ext(name){
            const i = (name || '').lastIndexOf('.');
            return i >= 0 ? name.slice(i+1).toLowerCase() : '';
          }

          input?.addEventListener('change', function(){
            list.innerHTML = '';
            const files = Array.from(input.files || []);
            let ok = true;

            if (files.length > MAX_COUNT) {
              ok = false;
              list.innerHTML = `<li class="text-danger">Máximo ${MAX_COUNT} archivos.</li>`;
            }

            files.forEach(f => {
              const li = document.createElement('li');
              const e  = ext(f.name);
              const badExt  = !ALLOWED.includes(e);
              const badSize = f.size > MAX_SIZE;

              li.textContent = `${f.name} — ${(f.size/1024).toFixed(0)} KB`;
              if (badExt || badSize) {
                ok = false;
                li.classList.add('text-danger');
                li.innerHTML += ` (inválido: ${badExt ? 'extensión' : ''}${(badExt&&badSize)?' y ':''}${badSize ? 'tamaño' : ''})`;
              }
              list.appendChild(li);
            });

            if (!ok) {
              // si algo inválido, limpiamos el input
              input.value = '';
            }
          });
        })();
    </script>

}
