@model solicitudMovimientosPcs.Models.ViewModels.MyRequestsViewModel
@using solicitudMovimientosPcs.Models
@{
    ViewData["Title"] = "Mis Solicitudes";
    int paraModificar = Model.ParaModificar?.Count ?? 0;
    int pendientes = Model.PendientesAprobacion?.Count ?? 0;
    int recientes = Model.Recientes?.Count ?? 0;

    string UrgBadge(Urgencia u)
        => u == Urgencia.Critica ? "badge bg-danger"
         : u == Urgencia.Alta ? "badge bg-warning text-dark"
         : u == Urgencia.Media ? "badge bg-info text-dark"
         : "badge bg-secondary";

    string StatBadge(RequestStatus s)
        => s == RequestStatus.Nuevo ? "badge bg-primary"
         : s == RequestStatus.EnProceso ? "badge bg-info text-dark"
         : s == RequestStatus.PorModificar ? "badge bg-warning text-dark"
         : s == RequestStatus.Rechazado ? "badge bg-danger"
         : "badge bg-secondary";
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Mis Solicitudes <small class="text-muted">(@Model.DisplayName)</small></h2>
    <a asp-action="Create" class="btn btn-primary">
        <i class="fa fa-plus me-1"></i> Nueva Solicitud
    </a>
</div>

<!-- KPIs -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="text-muted small">Para modificar</div>
                    <div class="h4 mb-0">@paraModificar</div>
                </div>
                <i class="fa fa-pen-to-square fa-lg text-warning"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="text-muted small">Pendientes de aprobación</div>
                    <div class="h4 mb-0">@pendientes</div>
                </div>
                <i class="fa fa-hourglass-half fa-lg text-primary"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="text-muted small">Recientes (últimos)</div>
                    <div class="h4 mb-0">@recientes</div>
                </div>
                <i class="fa fa-clock fa-lg text-secondary"></i>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-6">
                <label class="form-label">Buscar</label>
                <input id="flt-q" type="text" class="form-control" placeholder="ID, departamento, línea, tipo (FDO/PDO/WDO/MLO/ESTATUS)…">
            </div>
            <div class="col-md-3">
                <label class="form-label">Urgencia</label>
                <select id="flt-urg" class="form-select">
                    <option value="">Todas</option>
                    <option value="Critica">Crítica</option>
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Estatus</label>
                <select id="flt-stat" class="form-select">
                    <option value="">Todos</option>
                    <option value="Nuevo">Nuevo</option>
                    <option value="EnProceso">EnProceso</option>
                    <option value="PorModificar">PorModificar</option>
                    <option value="Rechazado">Rechazado</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-pills mb-3" id="my-req-tabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-modificar" data-bs-toggle="pill" data-bs-target="#pane-modificar" type="button" role="tab">
            <i class="fa fa-pen-to-square me-1"></i> Para Modificar (@paraModificar)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-pend" data-bs-toggle="pill" data-bs-target="#pane-pend" type="button" role="tab">
            <i class="fa fa-hourglass-half me-1"></i> Pendientes (@pendientes)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-rec" data-bs-toggle="pill" data-bs-target="#pane-rec" type="button" role="tab">
            <i class="fa fa-clock me-1"></i> Recientes (@recientes)
        </button>
    </li>
</ul>

<div class="tab-content">
    <!-- PARA MODIFICAR -->
    <div class="tab-pane fade show active" id="pane-modificar" role="tabpanel" aria-labelledby="tab-modificar">
        @if (!(Model.ParaModificar?.Any() ?? false))
        {
            <div class="alert alert-light">No tienes solicitudes para modificar.</div>
        }
        else
        {
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive h-scroll">
                        <table class="table table-hover align-middle mb-0 table-wide">
                            <thead class="table-light">
                                <tr>
                                    <th class="col-no sticky-col">ID</th>
                                    <th class="col-numparte sticky-col-2">Fecha</th>
                                    <th>Departamento</th>
                                    <th>Línea</th>
                                    <th>Tipos</th>
                                    <th>Urgencia</th>
                                    <th>Estatus</th>
                                    <th class="text-end">Items</th>
                                    <th class="text-end">Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tb-modificar">
                                @foreach (var r in Model.ParaModificar)
                                {
                                    var tipos = (r.PcTiposMovimiento ?? "")
                                    .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                                    var total = (r.Items?.Sum(i => i.Total ?? 0m) ?? 0m);
                                    <tr class="req-row"
                                        data-id="@r.Id"
                                        data-depto="@r.Departamento"
                                        data-linea="@r.Linea"
                                        data-urg="@r.Urgencia"
                                        data-stat="@r.RequestStatus"
                                        data-tipos="@string.Join(' ', tipos)">
                                        <td class="sticky-col">@r.Id</td>
                                        <td class="sticky-col-2">@r.Fecha:yyyy-MM-dd</td>
                                        <td>@r.Departamento</td>
                                        <td>@r.Linea</td>
                                        <td>
                                            @if (tipos.Any())
                                            {
                                                foreach (var t in tipos)
                                                {
                                                    <span class="badge bg-secondary me-1">@t</span>
                                                }
                                            }
                                            else
                                            {

                                                <span class="text-muted">—</span>
                                            }
                                        </td>
                                        <td><span class="@UrgBadge(r.Urgencia)">@r.Urgencia</span></td>
                                        <td><span class="@StatBadge(r.RequestStatus)">@r.RequestStatus</span></td>
                                        <td class="text-end">@((r.Items?.Count) ?? 0)</td>
                                        <td class="text-end">@total.ToString("N2")</td>
                                        <td class="text-end">
                                            <a asp-action="Edit" asp-route-id="@r.Id" class="btn btn-sm btn-warning">
                                                <i class="fa fa-edit me-1"></i> Editar y reenviar
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- PENDIENTES -->
    <div class="tab-pane fade" id="pane-pend" role="tabpanel" aria-labelledby="tab-pend">
        @if (!(Model.PendientesAprobacion?.Any() ?? false))
        {
            <div class="alert alert-light">No tienes solicitudes pendientes de aprobación.</div>
        }
        else
        {
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive h-scroll">
                        <table class="table table-hover align-middle mb-0 table-wide">
                            <thead class="table-light">
                                <tr>
                                    <th class="col-no sticky-col">ID</th>
                                    <th class="col-numparte sticky-col-2">Fecha</th>
                                    <th>Departamento</th>
                                    <th>Línea</th>
                                    <th>Tipos</th>
                                    <th>Urgencia</th>
                                    <th>Estatus</th>
                                    <th class="text-end">Items</th>
                                    <th class="text-end">Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tb-pend">
                                @foreach (var r in Model.PendientesAprobacion)
                                {
                                    var tipos = (r.PcTiposMovimiento ?? "")
                                    .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                                    var total = (r.Items?.Sum(i => i.Total ?? 0m) ?? 0m);
                                    <tr class="req-row"
                                        data-id="@r.Id"
                                        data-depto="@r.Departamento"
                                        data-linea="@r.Linea"
                                        data-urg="@r.Urgencia"
                                        data-stat="@r.RequestStatus"
                                        data-tipos="@string.Join(' ', tipos)">
                                        <td class="sticky-col">@r.Id</td>
                                        <td class="sticky-col-2">@r.Fecha:yyyy-MM-dd</td>
                                        <td>@r.Departamento</td>
                                        <td>@r.Linea</td>
                                        <td>
                                            @if (tipos.Any())
                                            {
                                                foreach (var t in tipos)
                                                {
                                                    <span class="badge bg-secondary me-1">@t</span>
                                                }
                                            }
                                            else
                                            {

                                                <span class="text-muted">—</span>
                                            }
                                        </td>
                                        <td><span class="@UrgBadge(r.Urgencia)">@r.Urgencia</span></td>
                                        <td><span class="@StatBadge(r.RequestStatus)">@r.RequestStatus</span></td>
                                        <td class="text-end">@((r.Items?.Count) ?? 0)</td>
                                        <td class="text-end">@total.ToString("N2")</td>
                                        <td class="text-end">
                                            <a asp-action="Details" asp-route-id="@r.Id" class="btn btn-sm btn-outline-primary">Ver</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- RECIENTES -->
    <div class="tab-pane fade" id="pane-rec" role="tabpanel" aria-labelledby="tab-rec">
        @if (!(Model.Recientes?.Any() ?? false))
        {
            <div class="alert alert-light">No hay solicitudes recientes.</div>
        }
        else
        {
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive h-scroll">
                        <table class="table table-hover align-middle mb-0 table-wide">
                            <thead class="table-light">
                                <tr>
                                    <th class="col-no sticky-col">ID</th>
                                    <th class="col-numparte sticky-col-2">Fecha</th>
                                    <th>Departamento</th>
                                    <th>Línea</th>
                                    <th>Tipos</th>
                                    <th>Urgencia</th>
                                    <th>Estatus</th>
                                    <th class="text-end">Items</th>
                                    <th class="text-end">Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tb-rec">
                                @foreach (var r in Model.Recientes)
                                {
                                    var tipos = (r.PcTiposMovimiento ?? "")
                                    .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                                    var total = (r.Items?.Sum(i => i.Total ?? 0m) ?? 0m);
                                    <tr class="req-row"
                                        data-id="@r.Id"
                                        data-depto="@r.Departamento"
                                        data-linea="@r.Linea"
                                        data-urg="@r.Urgencia"
                                        data-stat="@r.RequestStatus"
                                        data-tipos="@string.Join(' ', tipos)">
                                        <td class="sticky-col">@r.Id</td>
                                        <td class="sticky-col-2">@r.Fecha:yyyy-MM-dd</td>
                                        <td>@r.Departamento</td>
                                        <td>@r.Linea</td>
                                        <td>
                                            @if (tipos.Any())
                                            {
                                                foreach (var t in tipos)
                                                {
                                                    <span class="badge bg-secondary me-1">@t</span>
                                                }
                                            }
                                            else
                                            {

                                                <span class="text-muted">—</span>
                                            }
                                        </td>
                                        <td><span class="@UrgBadge(r.Urgencia)">@r.Urgencia</span></td>
                                        <td><span class="@StatBadge(r.RequestStatus)">@r.RequestStatus</span></td>
                                        <td class="text-end">@((r.Items?.Count) ?? 0)</td>
                                        <td class="text-end">@total.ToString("N2")</td>
                                        <td class="text-end">
                                            <a asp-action="Details" asp-route-id="@r.Id" class="btn btn-sm btn-outline-secondary">Ver</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        (function(){
          const q   = document.getElementById('flt-q');
          const urg = document.getElementById('flt-urg');
          const stat= document.getElementById('flt-stat');

          function activeTbody(){
            const pane = document.querySelector('.tab-pane.active.show');
            return pane ? pane.querySelector('tbody') : null;
          }

          function matches(row){
            const text = (q.value || '').trim().toLowerCase();
            const fUrg = (urg.value || '').trim();
            const fSta = (stat.value || '').trim();

            const id    = (row.dataset.id||'').toLowerCase();
            const depto = (row.dataset.depto||'').toLowerCase();
            const linea = (row.dataset.linea||'').toLowerCase();
            const tipos = (row.dataset.tipos||'').toLowerCase();
            const rUrg  = (row.dataset.urg||'');
            const rSta  = (row.dataset.stat||'');

            const hitText = !text || id.includes(text) || depto.includes(text) || linea.includes(text) || tipos.includes(text);
            const hitUrg  = !fUrg || rUrg === fUrg;
            const hitSta  = !fSta || rSta === fSta;
            return hitText && hitUrg && hitSta;
          }

          function applyFilters(){
            const tb = activeTbody();
            if(!tb) return;
            tb.querySelectorAll('.req-row').forEach(tr=>{
              tr.style.display = matches(tr) ? '' : 'none';
            });
          }

          q.addEventListener('input', applyFilters);
          urg.addEventListener('change', applyFilters);
          stat.addEventListener('change', applyFilters);

          // Reaplicar filtros al cambiar de pestaña
          document.getElementById('my-req-tabs')?.addEventListener('shown.bs.tab', applyFilters);

          // Primer pintado
          applyFilters();
        })();
    </script>
}

@section Styles {
    <style>
        /* Mantén tu diseño, pero haz que la tabla llene el card */
        .table-wide {
            width: 100% !important; /* anula width:max-content del css global */
            min-width: 1100px; /* tu mínimo para forzar scroll si hace falta */
            table-layout: auto; /* como ya usas */
        }

            /* La columna de acciones (última) no debe crecer */
            .table-wide th:last-child,
            .table-wide td:last-child {
                width: 1%;
                white-space: nowrap;
                text-align: right;
            }

        /* Evita que se vea el “reborde” blanco del contenido dentro del card redondeado */
        .card:has(.table-wide) {
            overflow: hidden;
        }
    </style>
}

