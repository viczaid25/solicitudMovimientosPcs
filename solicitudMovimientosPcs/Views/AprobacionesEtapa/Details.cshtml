@model solicitudMovimientosPcs.Models.PcMovimientosRequest
@using solicitudMovimientosPcs.Models
@{
    var stage = (string)ViewBag.Stage;
    var apro = ViewBag.Aprob as PcMovimientosAprobaciones;
    ViewData["Title"] = $"Detalle de Solicitud ({stage})";
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Solicitud #@Model.Id — @stage</h2>

    <div class="d-flex flex-column align-items-end gap-2" style="min-width:320px">
        @* Caja de comentarios del aprobador *@
        @if (IsStagePending(apro, stage))
        {
            <div class="w-100">
                <label class="form-label fw-semibold">Comentarios del aprobador</label>
                <textarea id="txtAprobComments" class="form-control" rows="2" placeholder="Explica el motivo (requerido para Modificar/Rechazar)"></textarea>
            </div>
        }

        <div class="d-flex gap-2">
            @if (IsStagePending(apro, stage))
            {
                if (EtapasPrevAprobadas(apro, stage))
                {
                    <!-- APROBAR -->
                    <form asp-controller="AprobacionesEtapa" asp-action="APPROVED"
                          asp-route-stage="@stage" asp-route-id="@Model.Id"
                          method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <button class="btn btn-success">
                            <i class="fas fa-check me-1"></i> Aprobar
                        </button>
                    </form>

                    <!-- MODIFICAR -->
                    <form id="frmModify" asp-controller="AprobacionesEtapa" asp-action="MODIFY"
                          asp-route-stage="@stage" asp-route-id="@Model.Id"
                          method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="comentario" id="commentsModify" />
                        <button type="submit" class="btn btn-warning text-dark">
                            <i class="fas fa-edit me-1"></i> Mandar a Modificar
                        </button>
                    </form>

                    <!-- RECHAZAR -->
                    <form id="frmReject" asp-controller="AprobacionesEtapa" asp-action="REJECTED"
                          asp-route-stage="@stage" asp-route-id="@Model.Id"
                          method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="comentario" id="commentsReject" />
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-times me-1"></i> Rechazar
                        </button>
                    </form>
                }
                else
                {
                    <span class="badge bg-secondary align-self-center">Esperando etapas previas</span>
                }
            }
            else
            {
                <span class="badge @(EstadoBadge(apro, stage)) align-self-center">
                    @InfoEtapa(apro, stage)
                </span>
            }
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3">Fecha</dt>
            <dd class="col-sm-9">@Model.Fecha.ToString("yyyy-MM-dd HH:mm")</dd>
            <dt class="col-sm-3">Solicitante</dt>
            <dd class="col-sm-9">@Model.Solicitante</dd>
            <dt class="col-sm-3">Departamento</dt>
            <dd class="col-sm-9">@Model.Departamento</dd>
            <dt class="col-sm-3">Línea</dt>
            <dd class="col-sm-9">@Model.Linea</dd>
            <dt class="col-sm-3">Urgencia</dt>
            <dd class="col-sm-9"><span class="@BadgeForUrgencia(Model.Urgencia)">@Model.Urgencia</span></dd>
            <dt class="col-sm-3">Comentarios</dt>
            <dd class="col-sm-9">@Model.Comentarios</dd>
        </dl>
    </div>
</div>

<div class="card">
    <div class="card-header">Items (@(Model.Items?.Count ?? 0))</div>
    <div class="card-body p-0">
        <div class="table-responsive h-scroll">
            <table class="table table-sm mb-0 align-middle table-wide">
                <thead class="table-light">
                    <tr>
                        <th class="col-no">No.</th>
                        <th class="col-numparte">Núm. Parte</th>
                        <th class="col-desc">Descripción</th>
                        <th class="col-case">Case</th>
                        <th class="col-codmov">CodMov</th>
                        <th class="col-a">Clase A</th>
                        <th class="col-a">Ubic A</th>
                        <th class="col-num">Cant A</th>
                        <th class="col-a">Estatus A</th>
                        <th class="col-d">Clase D</th>
                        <th class="col-d">Ubic D</th>
                        <th class="col-num">Cant D</th>
                        <th class="col-d">Estatus D</th>
                        <th class="col-mon">Moneda</th>
                        <th class="col-num">Costo U</th>
                        <th class="col-num">Diferencia</th>
                        <th class="col-num">Total</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var it in Model.Items ?? new List<PcMovimientosItem>())
                    {
                        <tr>
                            <td class="sticky-col">@it.Numero</td>
                            <td class="sticky-col-2">@it.NumParte</td>
                            <td>@it.Descripcion</td>
                            <td>@it.Case</td>
                            <td>@it.CodMov</td>
                            <td>@it.ClaseA</td>
                            <td>@it.UbicacionA</td>
                            <td class="text-end">@it.CantidadA?.ToString("0.##")</td>
                            <td>@it.EstatusA</td>
                            <td>@it.ClaseD</td>
                            <td>@it.UbicacionD</td>
                            <td class="text-end">@it.CantidadD?.ToString("0.##")</td>
                            <td>@it.EstatusD</td>
                            <td>@it.Moneda</td>
                            <td class="text-end">@it.CostoU?.ToString("0.##")</td>
                            <td class="text-end">@it.Diferencia?.ToString("0.##")</td>
                            <td class="text-end">@it.Total?.ToString("0.##")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@functions {
    string BadgeForUrgencia(Urgencia u) => u switch
    {
        Urgencia.Critica => "badge bg-danger",
        Urgencia.Alta => "badge bg-warning text-dark",
        Urgencia.Media => "badge bg-info text-dark",
        _ => "badge bg-secondary"
    };

    bool IsStagePending(PcMovimientosAprobaciones a, string st) => st switch
    {
        "MNG" => a?.MngStatus == ApprovalStatus.PENDING || a?.MngStatus == null,
        "JPN" => a?.JpnStatus == ApprovalStatus.PENDING || a?.JpnStatus == null,
        "MC" => a?.McStatus == ApprovalStatus.PENDING || a?.McStatus == null,
        "PL" => a?.PlStatus == ApprovalStatus.PENDING || a?.PlStatus == null,
        "PCMNG" => a?.PcMngStatus == ApprovalStatus.PENDING || a?.PcMngStatus == null,
        "PCJPN" => a?.PcJpnStatus == ApprovalStatus.PENDING || a?.PcJpnStatus == null,
        "FINMNG" => a?.FinMngStatus == ApprovalStatus.PENDING || a?.FinMngStatus == null,
        "FINJPN" => a?.FinJpnStatus == ApprovalStatus.PENDING || a?.FinJpnStatus == null,
        _ => false
    };

    bool EtapasPrevAprobadas(PcMovimientosAprobaciones a, string st)
    {
        string[] flow = new[] { "MNG", "JPN", "MC", "PL", "PCMNG", "PCJPN", "FINMNG", "FINJPN" };
        int idx = Array.IndexOf(flow, st);
        if (idx <= 0) return true;
        for (int i = 0; i < idx; i++)
        {
            if (!EtapaAprobada(a, flow[i])) return false;
        }
        return true;
    }

    bool EtapaAprobada(PcMovimientosAprobaciones a, string st) => st switch
    {
        "MNG" => a?.MngStatus == ApprovalStatus.APPROVED,
        "JPN" => a?.JpnStatus == ApprovalStatus.APPROVED,
        "MC" => a?.McStatus == ApprovalStatus.APPROVED,
        "PL" => a?.PlStatus == ApprovalStatus.APPROVED,
        "PCMNG" => a?.PcMngStatus == ApprovalStatus.APPROVED,
        "PCJPN" => a?.PcJpnStatus == ApprovalStatus.APPROVED,
        "FINMNG" => a?.FinMngStatus == ApprovalStatus.APPROVED,
        "FINJPN" => a?.FinJpnStatus == ApprovalStatus.APPROVED,
        _ => false
    };

    string EstadoBadge(PcMovimientosAprobaciones a, string st)
    {
        var s = st switch
        {
            "MNG" => a?.MngStatus,
            "JPN" => a?.JpnStatus,
            "MC" => a?.McStatus,
            "PL" => a?.PlStatus,
            "PCMNG" => a?.PcMngStatus,
            "PCJPN" => a?.PcJpnStatus,
            "FINMNG" => a?.FinMngStatus,
            "FINJPN" => a?.FinJpnStatus,
            _ => null
        };
        return s == ApprovalStatus.APPROVED ? "bg-success"
             : s == ApprovalStatus.REJECTED ? "bg-danger"
             : "bg-secondary";
    }

    string InfoEtapa(PcMovimientosAprobaciones a, string st)
    {
        string? user = st switch
        {
            "MNG" => a?.Mng,
            "JPN" => a?.Jpn,
            "MC" => a?.Mc,
            "PL" => a?.Pl,
            "PCMNG" => a?.PcMng,
            "PCJPN" => a?.PcJpn,
            "FINMNG" => a?.FinMng,
            "FINJPN" => a?.FinJpn,
            _ => null
        };
        ApprovalStatus? status = st switch
        {
            "MNG" => a?.MngStatus,
            "JPN" => a?.JpnStatus,
            "MC" => a?.McStatus,
            "PL" => a?.PlStatus,
            "PCMNG" => a?.PcMngStatus,
            "PCJPN" => a?.PcJpnStatus,
            "FINMNG" => a?.FinMngStatus,
            "FINJPN" => a?.FinJpnStatus,
            _ => null
        };
        DateTime? date = st switch
        {
            "MNG" => a?.MngDate,
            "JPN" => a?.JpnDate,
            "MC" => a?.McDate,
            "PL" => a?.PlDate,
            "PCMNG" => a?.PcMngDate,
            "PCJPN" => a?.PcJpnDate,
            "FINMNG" => a?.FinMngDate,
            "FINJPN" => a?.FinJpnDate,
            _ => null
        };
        return $"{st}: {user ?? "-"} — {status} — {date?.ToString("yyyy-MM-dd HH:mm")}";
    }
}

@section Scripts {
    <script>
        (function () {
            const txt = document.getElementById('txtAprobComments');
            const frmModify = document.getElementById('frmModify');
            const frmReject = document.getElementById('frmReject');

            function mustHaveComments(e, hiddenId){
                const val = (txt?.value || '').trim();
                if (!val) {
                    e.preventDefault();
                    alert('Por favor especifica comentarios para Modificar/Rechazar.');
                    txt?.focus();
                    return false;
                }
                const hid = document.getElementById(hiddenId);
                if (hid) hid.value = val;
                return true;
            }

            if (frmModify) {
                frmModify.addEventListener('submit', function (e) {
                    mustHaveComments(e, 'commentsModify');
                });
            }
            if (frmReject) {
                frmReject.addEventListener('submit', function (e) {
                    // Confirmación adicional opcional
                    if (!confirm('¿Rechazar la solicitud?')) { e.preventDefault(); return; }
                    mustHaveComments(e, 'commentsReject');
                });
            }
        })();
    </script>
}

@section Styles {
    <style>
        .h-scroll {
            overflow-x: auto;
        }

        .table-wide {
            min-width: 1600px;
        }
            /* fuerza el scroll horizontal */
            .table-wide th, .table-wide td {
                white-space: nowrap;
            }

        /* Anchos sugeridos por columna */
        .col-no {
            min-width: 70px
        }

        .col-numparte {
            min-width: 160px
        }

        .col-desc {
            min-width: 320px
        }
        /* Descripción más amplia */
        .col-case {
            min-width: 200px
        }
        /* Case más grande */
        .col-codmov {
            min-width: 120px
        }
        /* CodMov más compacto */
        .col-a {
            min-width: 120px
        }

        .col-d {
            min-width: 120px
        }

        .col-num {
            min-width: 110px;
            text-align: right
        }

        .col-mon {
            min-width: 100px
        }

        /* Mantener visibles las primeras columnas al hacer scroll */
        .sticky-col, .sticky-col-2 {
            position: sticky;
            background: #fff;
            z-index: 1;
        }

        .sticky-col {
            left: 0;
        }

        .sticky-col-2 {
            left: 70px;
        }
        /* igual al min-width de .col-no */
        thead .sticky-col, thead .sticky-col-2 {
            z-index: 2;
            background: #f8f9fa;
        }
    </style>
}
